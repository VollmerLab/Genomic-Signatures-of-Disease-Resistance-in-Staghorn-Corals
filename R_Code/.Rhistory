library(tidyverse)
library(magrittr)
library(xml2)
library(adegenet)
library(poppr)
library(reticulate)
#### Functions ####
convert_to_decimal <- function(x){
out <- str_split(x, 'W|N') %>%
unlist(recursive = FALSE) %>%
as.numeric() %>%
magrittr::divide_by(c(1, 60)) %>%
sum
if_else(str_detect(x, 'W'), -1 * out, out)
}
srr_to_srs <- function(data){
pysradb <- import('pysradb')
db = pysradb$SRAweb()
srr_ids <- filter(data, !is.na(SRR_id)) %>%
pull(SRR_id)
out <- db$srr_to_srs(srr_ids, detailed = FALSE,
sample_attribute = FALSE,
expand_sample_attributes = FALSE) %>%
as_tibble() %>%
select(run_accession, sample_accession) %>%
rename(SRS_id = sample_accession, SRR_id = run_accession)
full_join(data, out, by = 'SRR_id')
}
#### Gather Collection Location Data ####
florida_locations <- read_csv('../Data/SP.pop.data.csv', show_col_types = FALSE) %>%
select(Genotype, subregion, reefName, x.coord, y.coord) %>%
rename(gen_id = Genotype,
lat = x.coord,
lon = y.coord) %>%
mutate(reef = str_c(subregion, reefName, sep = '-'), .keep = 'unused')
panama_locations <- tribble(
~'reef', ~'lon_garmin', ~'lat_garmin',
'tetas', '82W6.068', '9N16.579',
'sebastians', '82W7.631', '9N15.274',
'holy shit', '82W6.929', '9N16.773',
'CK14', '82W7.557', '9N15.238',
'CK4', '82W7.625', '9N15.517'
) %>%
rowwise %>%
mutate(lat = convert_to_decimal(lat_garmin),
lon = convert_to_decimal(lon_garmin)) %>%
ungroup %>%
select(-ends_with('garmin')) %>%
mutate(reef = str_replace_all(reef, c('tetas' = 'Tet', 'sebastians' = 'SR', 'holy shit' = 'HS')))
#### Process Baum Lab Locations ###
baum_locations <- read_xml('../Data/biosample_result.xml') %>%
as_list() %>%
as_tibble %>%
unnest_wider(BioSampleSet) %>%
rowwise %>%
mutate(SRS_id = Ids[[3]][[1]]) %>%
mutate(location = Attributes[[3]][[1]] %>% str_remove(' \\(.*\\)')) %>%
select(SRS_id, location)
#### Read in Genetic file data & Join All data ####
all_individual_data <- read_delim('../Data/bam.list', delim = '\t',
col_names = 'file', show_col_types = FALSE) %>%
mutate(ID = str_remove(file, dirname(file)) %>% str_remove('/') %>% str_remove('-fp.*bam$')) %>%
select(-file) %>%
mutate(SRR_id = str_extract(ID, 'SRR[0-9]+')) %>%
srr_to_srs() %>%
left_join(baum_locations, by = 'SRS_id') %>%
select(-SRR_id, -SRS_id) %>%
mutate(gen_id = str_extract(ID, '[A-Za-z0-9]+$')) %>%
left_join(florida_locations, by = 'gen_id') %>%
mutate(data_origin = if_else(str_detect(ID, 'baum'), 'baum', 'vollmer'),
species = str_extract(ID, 'A[cp]|ac|apr|apa') %>% str_to_sentence(),
location = if_else(is.na(location), str_extract(ID, 'FL|PA'), location) %>% str_replace_all(c('^FL$' = 'Florida', '^PA$' = 'Panama')),
reef = if_else(data_origin == 'vollmer' & location == 'Panama', str_extract(ID, 'CK4|CK14|HS|SR|Tet'), reef)) %>%
select(ID, gen_id, data_origin, species, location, reef, lat, lon) %>%
left_join(panama_locations, by = 'reef') %>%
mutate(lat = coalesce(lat.x, lat.y),
lon = coalesce(lon.x, lon.y),
.keep = 'unused')
dir.create('../intermediate_files')
write_csv(all_individual_data, '../intermediate_files/collected_sample_metadata.csv')
#### Libraries ####
library(tidyverse)
library(mgcv)
library(gratia)
library(patchwork)
#### Read in Data ####
full_tank_data <- read_csv('../Data/Combo_Census.csv', show_col_types = FALSE) %>%
pivot_longer(cols = where(is.numeric),
names_to = 'day',
values_to = 'infected',
names_transform = as.numeric,
values_transform = as.integer,
values_drop_na = TRUE) %>%
janitor::clean_names() %>%
#Keep only diseased treatment since healthy treatment not involved in calculation of disease resistance
# filter(treatment == 'D') %>%
#Remove Tanks which crashed due to anoxia
filter(treatment != 'Treatment') %>%
filter(!((tank == 'H1' & location == 'PA') | (tank == 'H2' & location == 'FL') |
(tank == 'H3' & location == 'FL'))) %>%
#Recode to match with
mutate(location = str_replace_all(location, c('FL' = 'Florida', 'PA' = 'Panama')),
across(c(site, genotype), ~str_replace_all(., c('Holyshit' = 'HS', 'Sebastian' = 'SR', 'Tetas' = 'Tet'))),
site = if_else(location == 'Florida', NA_character_, site),
genotype = str_remove(genotype, '_[0-9]+_')) %>%
dplyr::rename(reef = site,
gen_id = genotype) %>%
select(-reef) %>%
left_join(read_csv('../intermediate_files/collected_sample_metadata.csv', show_col_types = FALSE) %>%
select(-location),
by = 'gen_id') %>%
mutate(dummy1 = 1,
dummy2 = 1,
dummy3 = 1,
across(where(is.character), as.factor)) %>%
select(-species, -data_origin, -ID)
#### Estimate Disease Resistance - assume location effect is purely the result of experimental differences ####
survival_model_locationExperimental <- gam(day ~ treatment + s(location, bs = 're', by = dummy1) +
# s(location, reef, bs = 're', by = dummy) +
s(location, gen_id, bs = 're', by = dummy3) +
# s(location, reef, gen_id, clone_group, bs = 're', by = dummy) +
s(location, tank, bs = 're', by = dummy2),
weights = infected,
family = cox.ph(),
data = full_tank_data,
method = 'REML',
control = gam.control(nthreads = 4, trace = TRUE))
summary(survival_model_locationExperimental)
survival_model_locationExperimental2 <- gam(day ~ s(location, bs = 're', by = dummy1) +
# s(location, reef, bs = 're', by = dummy) +
s(location, gen_id, bs = 're', by = dummy3) +
# s(location, reef, gen_id, clone_group, bs = 're', by = dummy) +
s(location, tank, bs = 're', by = dummy2),
weights = infected,
family = cox.ph(),
data = filter(full_tank_data, treatment == 'D'),
method = 'REML',
control = gam.control(nthreads = 4, trace = TRUE))
summary(survival_model_locationExperimental2)
#### Get Deviance Explained by Individual Components ####
survival_model_locationExperimental_noID <- gam(day ~ s(location, bs = 're', by = dummy1) +
s(location, tank, bs = 're', by = dummy2),
weights = infected,
family = cox.ph(),
data = filter(full_tank_data, treatment == 'D'),
method = 'REML',
control = gam.control(nthreads = 4, trace = TRUE))
summary(survival_model_locationExperimental_noID)
survival_model_locationExperimental_noTank <- gam(day ~ s(location, bs = 're', by = dummy1) +
s(location, gen_id, bs = 're', by = dummy3),
weights = infected,
family = cox.ph(),
data = filter(full_tank_data, treatment == 'D'),
method = 'REML',
control = gam.control(nthreads = 4, trace = TRUE))
summary(survival_model_locationExperimental_noTank)
survival_model_locationExperimental_onlyLocation <- gam(day ~ s(location, bs = 're', by = dummy1),
weights = infected,
family = cox.ph(),
data = filter(full_tank_data, treatment == 'D'),
method = 'REML',
control = gam.control(nthreads = 4, trace = TRUE))
summary(survival_model_locationExperimental_onlyLocation)
#### Percent var explained by genotype in each location alone ####
just_florida_full <- gam(day ~ s(gen_id, bs = 're', by = dummy3) +
s(tank, bs = 're', by = dummy2),
weights = infected,
family = cox.ph(),
data = filter(full_tank_data, treatment == 'D',
location == 'Florida'),
method = 'REML',
control = gam.control(nthreads = 4, trace = TRUE))
summary(just_florida_full)
just_florida_full_noTank <- gam(day ~ s(gen_id, bs = 're', by = dummy3),
weights = infected,
family = cox.ph(),
data = filter(full_tank_data, treatment == 'D',
location == 'Florida'),
method = 'REML',
control = gam.control(nthreads = 4, trace = TRUE))
summary(just_florida_full_noTank)
just_florida_full_noGen <- gam(day ~ s(tank, bs = 're', by = dummy2),
weights = infected,
family = cox.ph(),
data = filter(full_tank_data, treatment == 'D',
location == 'Florida'),
method = 'REML',
control = gam.control(nthreads = 4, trace = TRUE))
summary(just_florida_full_noGen)
just_panama_full <- gam(day ~ s(gen_id, bs = 're', by = dummy3) +
s(tank, bs = 're', by = dummy2),
weights = infected,
family = cox.ph(),
data = filter(full_tank_data, treatment == 'D',
location == 'Panama'),
method = 'REML',
control = gam.control(nthreads = 4, trace = TRUE))
summary(just_panama_full)
just_panama_full_noTank <- gam(day ~ s(gen_id, bs = 're', by = dummy3),
weights = infected,
family = cox.ph(),
data = filter(full_tank_data, treatment == 'D',
location == 'Panama'),
method = 'REML',
control = gam.control(nthreads = 4, trace = TRUE))
summary(just_panama_full_noTank)
just_panama_full_noGen <- gam(day ~ s(tank, bs = 're', by = dummy2),
weights = infected,
family = cox.ph(),
data = filter(full_tank_data, treatment == 'D',
location == 'Panama'),
method = 'REML',
control = gam.control(nthreads = 4, trace = TRUE))
summary(just_panama_full_noGen)
#### Plot Survivorship Curves ####
full_tank_data %>%
filter(treatment == 'D') %>%
mutate(gen_id = str_c('G', location)) %>%
select(gen_id, location, treatment) %>%
distinct %>%
mutate(dummy1 = 1,
dummy2 = 0,
dummy3 = 0,
tank = 'sim') %>%
expand_grid(day = seq(0, 7, length.out = 1000)) %>%
bind_cols(., predict(survival_model_locationExperimental, newdata = ., se.fit = TRUE, type = 'response')) %>%
ggplot(aes(x = day, y = fit, colour = location,
ymin = fit - se.fit, ymax = fit + se.fit,
fill = location)) +
geom_ribbon(alpha = 0.5, colour = NA, show.legend = FALSE) +
geom_line(show.legend = FALSE) +
scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
labs(x = 'Experiment Day',
y = 'Fragment Survival (%)') +
theme_classic() +
theme(plot.background = element_rect(size = 1, linetype = 'solid', colour = NA, fill = "black"),
panel.background = element_rect(size = 1, linetype = 'solid', colour = 'white', fill = "black"),
axis.title = element_text(size = 18, colour = 'white'),
axis.text = element_text(size = 14, colour = 'white'),
axis.ticks = element_line(colour = 'white'),
axis.line = element_line(colour = 'white'))
#### Estimate Disease Resistance ####
disease_resistance <- full_tank_data %>%
select(gen_id, location, treatment) %>%
distinct %>%
mutate(dummy1 = 0,
dummy2 = 0,
dummy3 = 1,
tank = 'sim',
day = 6) %>%
bind_cols(., predict(survival_model_locationExperimental, newdata = ., se.fit = TRUE, type = 'response')) %>%
dplyr::rename(disease_resistance = fit) %>%
select(-se.fit) %>%
mutate(dummy1 = 1) %>%
# mutate(day = 5) %>%
bind_cols(., predict(survival_model_locationExperimental, newdata = ., se.fit = TRUE, type = 'response')) %>%
dplyr::rename(disease_resistance_with_location = fit) %>%
select(-se.fit, -tank, -dummy1, -dummy2, -day) %>%
mutate(disease_resistance = as.numeric(disease_resistance),
disease_resistance_with_location = as.numeric(disease_resistance_with_location)) %>%
select(-disease_resistance_with_location, -dummy3)
write_csv(disease_resistance, '../intermediate_files/disease_resistance.csv')
